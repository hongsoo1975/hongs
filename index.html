<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Scoreboard Display</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Jua&family=Nanum+Gothic:wght@400;700&family=Noto+Sans+KR:wght@100;300;400;500;700;900&family=Nanum+Myeongjo:wght@400;700;800&family=Poor+Story&family=Single+Day&family=Sunflower:wght@300;500;700&family=Stylish&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            background-color: rgba(0, 0, 0, 0) !important;
            background: transparent !important;
            font-family: 'Noto Sans KR', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            touch-action: none;
            -webkit-background-color: rgba(0, 0, 0, 0) !important;
        }

        .scoreboard {
            border-radius: 8px;
            padding: 4px;
            display: inline-block;
            transform-origin: top left;
            transition: transform 0.3s ease;
        }

        table {
            border-collapse: collapse;
            overflow: hidden;
        }

        td {
            padding: 10px 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .team-name {
            min-width: 150px;
        }

        .score {
            min-width: 60px;
            transition: all 0.3s ease;
        }

        .score.hidden {
            display: none;
            width: 0;
            padding: 0;
            border: none;
        }

        .drag-handle {
            position: absolute;
            top: -20px;
            left: 0;
            right: 0;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            cursor: move;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 4px;
        }

        .resize-handle {
            position: absolute;
            bottom: -20px;
            right: -20px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            cursor: se-resize;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 50%;
        }

        .scoreboard-container {
            position: absolute;
            background: transparent;
        }

        .scoreboard-container:hover .drag-handle,
        .scoreboard-container:hover .resize-handle {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="scoreboard-container" style="position: absolute; left: 50px; top: 50px;">
        <div class="drag-handle"></div>
        <div class="scoreboard">
            <table>
                <tr id="team1-row">
                    <td class="team-name">팀 1</td>
                    <td class="score" data-set="0">0</td>
                    <td class="score hidden" data-set="1">0</td>
                    <td class="score hidden" data-set="2">0</td>
                </tr>
                <tr id="team2-row">
                    <td class="team-name">팀 2</td>
                    <td class="score" data-set="0">0</td>
                    <td class="score hidden" data-set="1">0</td>
                    <td class="score hidden" data-set="2">0</td>
                </tr>
            </table>
        </div>
        <div class="resize-handle"></div>
    </div>

    <script>
        const container = document.querySelector('.scoreboard-container');
        const scoreboard = document.querySelector('.scoreboard');
        const dragHandle = document.querySelector('.drag-handle');
        const resizeHandle = document.querySelector('.resize-handle');

        let isDragging = false;
        let isResizing = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;

        let xOffset = parseInt(localStorage.getItem('scoreboardX')) || 50;
        let yOffset = parseInt(localStorage.getItem('scoreboardY')) || 50;
        let scale = parseFloat(localStorage.getItem('scoreboardScale')) || 1;

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('scoreboardSettings')) || {
                tableBgColor: '#1e40af',
                teamNameBgColor: '#1e40af',
                scoreBgColor: '#2563eb',
                currentSetColor: '#3b82f6',
                textColor: '#ffffff',
                fontFamily: "'Noto Sans KR'",
                fontWeight: '400',
                fontStyle: 'normal',
                teamNameSize: 18,
                scoreSize: 24,
                borderRadius: 8,
                opacity: 95,
                shadowIntensity: 4
            };

            const table = document.querySelector('table');
            const opacity = settings.opacity / 100;
            const opacityHex = Math.round(opacity * 255).toString(16).padStart(2, '0');

            // 테이블 스타일
            table.style.background = `${settings.tableBgColor}${opacityHex}`;
            table.style.borderRadius = `${settings.borderRadius}px`;
            table.style.boxShadow = `0 ${settings.shadowIntensity}px ${settings.shadowIntensity * 1.5}px rgba(0,0,0,0.2)`;
            table.style.fontFamily = `${settings.fontFamily}, sans-serif`;

            // 팀 이름 스타일
            document.querySelectorAll('.team-name').forEach(cell => {
                cell.style.background = `${settings.teamNameBgColor}${opacityHex}`;
                cell.style.color = settings.textColor;
                cell.style.fontSize = `${settings.teamNameSize}px`;
                cell.style.fontWeight = settings.fontWeight;
                cell.style.fontStyle = settings.fontStyle;
            });

            // 점수 스타일 - 같은 세트는 같은 배경색
            const team1Scores = Array.from(document.querySelectorAll('#team1-row .score:not(.hidden)'));
            const team2Scores = Array.from(document.querySelectorAll('#team2-row .score:not(.hidden)'));
            const currentSetIndex = team1Scores.length - 1;

            for (let i = 0; i < team1Scores.length; i++) {
                const isCurrentSet = i === currentSetIndex;
                const backgroundColor = isCurrentSet ? settings.currentSetColor : settings.scoreBgColor;
                
                [team1Scores[i], team2Scores[i]].forEach(cell => {
                    cell.style.background = `${backgroundColor}${opacityHex}`;
                    cell.style.color = settings.textColor;
                    cell.style.fontSize = `${settings.scoreSize}px`;
                    cell.style.fontWeight = settings.fontWeight;
                    cell.style.fontStyle = settings.fontStyle;
                });
            }
        }

        function setTranslate(xPos, yPos, el) {
            el.style.left = xPos + "px";
            el.style.top = yPos + "px";
            localStorage.setItem('scoreboardX', xPos);
            localStorage.setItem('scoreboardY', yPos);
        }

        function setScale(newScale) {
            scale = newScale;
            scoreboard.style.transform = `scale(${scale})`;
            localStorage.setItem('scoreboardScale', scale);
        }

        dragHandle.addEventListener('mousedown', dragStart);
        dragHandle.addEventListener('touchstart', dragStart);
        resizeHandle.addEventListener('mousedown', resizeStart);
        resizeHandle.addEventListener('touchstart', resizeStart);
        document.addEventListener('mousemove', move);
        document.addEventListener('touchmove', move);
        document.addEventListener('mouseup', end);
        document.addEventListener('touchend', end);

        function dragStart(e) {
            if (e.type === 'touchstart') {
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            } else {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }

            if (e.target === dragHandle) {
                isDragging = true;
            }
        }

        function resizeStart(e) {
            if (e.type === 'touchstart') {
                initialX = e.touches[0].clientX;
                initialY = e.touches[0].clientY;
            } else {
                initialX = e.clientX;
                initialY = e.clientY;
            }

            initialWidth = scale;
            isResizing = true;
        }

        function move(e) {
            if (isDragging) {
                e.preventDefault();
                
                if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }

                xOffset = currentX;
                yOffset = currentY;
                setTranslate(currentX, currentY, container);
            }

            if (isResizing) {
                e.preventDefault();
                
                let currentWidth;
                if (e.type === 'touchmove') {
                    currentWidth = initialWidth + (e.touches[0].clientX - initialX) * 0.005;
                } else {
                    currentWidth = initialWidth + (e.clientX - initialX) * 0.005;
                }

                currentWidth = Math.max(0.5, Math.min(2, currentWidth));
                setScale(currentWidth);
            }
        }

        function end() {
            isDragging = false;
            isResizing = false;
        }

        const SHEET_ID = '1wlPWiFQaIS39ZjgGTU9FomJBOw7q-6hQCK03G9mMdYk';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
        
        let lastData = null;

        async function updateScoreboard() {
            try {
                const response = await fetch(`${SHEET_URL}&_=${Date.now()}`);
                const text = await response.text();
                const rows = text.split('\n').map(row => 
                    row.split(',').map(cell => cell.replace(/"/g, '').trim())
                );

                const currentData = {
                    currentSet: parseInt(rows[1][1]) || 1,
                    team1: {
                        name: rows[1][0],
                        scores: [rows[1][2], rows[1][3], rows[1][4]]
                    },
                    team2: {
                        name: rows[2][0],
                        scores: [rows[2][2], rows[2][3], rows[2][4]]
                    }
                };

                if (!lastData || JSON.stringify(lastData) !== JSON.stringify(currentData)) {
                    const teamNames = document.querySelectorAll('.team-name');
                    const team1Scores = document.querySelectorAll('#team1-row .score');
                    const team2Scores = document.querySelectorAll('#team2-row .score');

                    teamNames[0].textContent = currentData.team1.name;
                    teamNames[1].textContent = currentData.team2.name;

                    // 모든 세트 숨기기
                    team1Scores.forEach(score => {
                        score.classList.add('hidden');
                        score.textContent = '0';
                    });
                    team2Scores.forEach(score => {
                        score.classList.add('hidden');
                        score.textContent = '0';
                    });

                    // 현재 세트까지만 표시
                    for (let i = 0; i < currentData.currentSet; i++) {
                        if (i < 3) {  // 최대 3세트까지만
                            team1Scores[i].classList.remove('hidden');
                            team2Scores[i].classList.remove('hidden');
                            team1Scores[i].textContent = currentData.team1.scores[i] || '0';
                            team2Scores[i].textContent = currentData.team2.scores[i] || '0';
                        }
                    }

                    lastData = {...currentData};
                    loadSettings();
                }
            } catch (error) {
                console.error('Error fetching scoreboard data:', error);
            }
        }

        // 초기 설정 및 업데이트
        setTranslate(xOffset, yOffset, container);
        setScale(scale);
        loadSettings();
        setInterval(updateScoreboard, 1000);
        setInterval(loadSettings, 1000);
        updateScoreboard();
    </script>
</body>
</html>
